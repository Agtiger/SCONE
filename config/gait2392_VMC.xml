<?xml version="1.0" encoding="utf-8"?>
<Optimizer type="CmaOptimizer">
	<INCLUDE file="optimizations/O_CMA.xml" merge_children="1"/>
	<Objective type="SimulationObjective">
		<signature_postfix>VMC6</signature_postfix>
		<max_duration>5</max_duration>
		<Model type="Simbody">
			<model_file>f2392b.osim</model_file>
			<state_init_file>f2354_init_walk_3_S10.sto</state_init_file>
			<sensor_delay_scaling_factor>1.0</sensor_delay_scaling_factor>
			<integration_method>SemiExplicitEuler2</integration_method>
			<integration_accuracy>0.001</integration_accuracy>
			<use_fixed_control_step_size>1</use_fixed_control_step_size>
			<fixed_control_step_size>0.001</fixed_control_step_size>
			<custom_properties>
				<meta_reflex_control use_length="1" use_constant="1" use_force="1" use_stiffness="1" use_balance="1"/>
			</custom_properties>
			<balance_sensor_delay>0.0</balance_sensor_delay>
			<balance_sensor_ori_vel_gain init_mean="0.15" init_std="0.01" min="0" max="1" is_free="1"/>
			
			<Controllers>
				<Controller type="GaitStateController">
					<landing_threshold init_mean="0.1" init_std="0.01" min="-0.5" max="0.5" is_free="1"/>
					<late_stance_threshold init_mean="-0.1" init_std="0.01" min="-0.5" max="0.5" is_free="1"/>
					<stance_load_threshold init_mean="0.05" init_std="0.01" min="0.001" max="1.0" is_free="1"/>
					<swing_load_threshold init_mean="0.03" init_std="0.01" min="0.001" max="1.0" is_free="1"/>
					<leg_load_sensor_delay>0.02</leg_load_sensor_delay>
					<ConditionalControllers>
					
						<!-- Hip and knee stance, upper body posture -->
						<ConditionalController states="EarlyStance LateStance">
							<Controller type="MetaReflexController">
								<Reflexes>
									<!-- Upper body balance -->
									<Reflex type="VirtualMuscleReflex" target="lumbar_extension 1" delay="0.005">
										<L init_mean="2.0" init_std="0.1" min="0" max="10" is_free="1"/>
										<C init_mean="0.0" init_std="0.1" min="-1" max="1" is_free="1"/>
										<Balance body="torso">
											<C init_mean="-2" init_std="0.2" min="-10" max="10" is_free="1"/>
										</Balance>
									</Reflex>
									<Reflex type="VirtualMuscleReflex" target="lumbar_extension -1" delay="0.005">
										<L init_mean="2.0" init_std="0.1" min="0" max="10" is_free="1"/>
										<C init_mean="0.0" init_std="0.1" min="-1" max="1" is_free="1"/>
										<Balance body="torso">
											<C init_mean="2" init_std="0.2" min="-10" max="10" is_free="1"/>
										</Balance>
									</Reflex>
									<!-- Upper body balance (coronal) -->
									<Reflex type="VirtualMuscleReflex" target="lumbar_bending 1" delay="0.005">
										<L init_mean="1.0" init_std="0.1" min="0" max="10" is_free="1"/>
										<C init_mean="0.1" init_std="0.1" min="-1" max="1" is_free="1"/>
										<Balance body="torso">
											<C init_mean="-2" init_std="0.2" min="-10" max="10" is_free="1"/>
										</Balance>
									</Reflex>
									<Reflex type="VirtualMuscleReflex" target="lumbar_bending -1" delay="0.005">
										<L init_mean="1.0" init_std="0.1" min="0" max="10" is_free="1"/>
										<C init_mean="0.1" init_std="0.1" min="-1" max="1" is_free="1"/>
										<Balance body="torso">
											<C init_mean="2" init_std="0.2" min="-10" max="10" is_free="1"/>
										</Balance>
									</Reflex>
									<!-- Root balance (sagittal) -->
									<Reflex type="VirtualMuscleReflex" target="hip_flexion 1" delay="0.005">
										<L init_mean="0.1" init_std=".01" min="0" max="10" is_free="1"/>
										<C init_mean="0.0" init_std="0.1" min="-1" max="1" is_free="1"/>
										<Balance body="pelvis">
											<C init_mean="2" init_std="0.2" min="-10" max="10" is_free="1"/>
										</Balance>
									</Reflex>
									<Reflex type="VirtualMuscleReflex" target="hip_flexion -1" delay="0.005">
										<L init_mean="0.1" init_std=".01" min="0" max="10" is_free="1"/>
										<C init_mean="0.0" init_std="0.1" min="-1" max="1" is_free="1"/>
										<Balance body="pelvis">
											<C init_mean="-2" init_std="0.2" min="-10" max="10" is_free="1"/>
										</Balance>
									</Reflex>
									<!-- Root balance (coronal) -->
									<Reflex type="VirtualMuscleReflex" target="hip_adduction 1" delay="0.005">
										<L init_mean="0.1" init_std="0.01" min="0" max="10" is_free="1"/>
										<C init_mean="0.1" init_std="0.01" min="-1" max="1" is_free="1"/>
										<Balance body="pelvis">
											<C init_mean="2" init_std="0.2" min="-10" max="10" is_free="1"/>
										</Balance>
									</Reflex>
									<Reflex type="VirtualMuscleReflex" target="hip_adduction -1" delay="0.005">
										<L init_mean="0.5" init_std="0.1" min="0" max="10" is_free="1"/>
										<C init_mean="0.5" init_std="0.1" min="-1" max="1" is_free="1"/>
										<Balance body="pelvis">
											<C init_mean="-2" init_std="0.2" min="-10" max="10" is_free="1"/>
										</Balance>
									</Reflex>
									<!-- Root balance (transverse) -->
									<Reflex type="VirtualMuscleReflex" target="hip_rotation 1" delay="0.005">
										<L init_mean="1.0" init_std="0.1" min="0" max="10" is_free="1"/>
										<C init_mean="0.1" init_std="0.02" min="-1" max="1" is_free="1"/>
										<Balance body="pelvis">
											<C init_mean="2" init_std="0.2" min="-10" max="10" is_free="1"/>
										</Balance>
									</Reflex>
									<Reflex type="VirtualMuscleReflex" target="hip_rotation -1" delay="0.005">
										<L init_mean="1.0" init_std="0.1" min="0" max="10" is_free="1"/>
										<C init_mean="0.1" init_std="0.02" min="-1" max="1" is_free="1"/>
										<Balance body="pelvis">
											<C init_mean="-2" init_std="0.2" min="-10" max="10" is_free="1"/>
										</Balance>
									</Reflex>
									<!-- Knee extension -->
									<Reflex type="VirtualMuscleReflex" target="knee_angle 1" delay="0.010">
										<L init_mean="1.5" init_std="0.2" min="0" max="10" is_free="1"/>
										<C init_mean="0.5" init_std="0.05" min="-10" max="10" is_free="1"/>
									</Reflex>
									<!-- Ankle stability -->
									<Reflex type="VirtualMuscleReflex" target="ankle_angle 1" delay="0.020">
										<L init_mean="2.0" init_std="0.2" min="0" max="10" is_free="1"/>
										<C init_mean="0.2" init_std="0.02" min="-10" max="10" is_free="1"/>
									</Reflex>
									<Reflex type="VirtualMuscleReflex" target="ankle_angle -1" delay="0.020">
										<L init_mean="2.0" init_std="0.2" min="0" max="10" is_free="1"/>
										<C init_mean="0.2" init_std="0.02" min="-10" max="10" is_free="1"/>
									</Reflex>
									<Reflex type="VirtualMuscleReflex" target="subtalar_angle 1" delay="0.020">
										<L init_mean="2.0" init_std="0.2" min="0" max="10" is_free="1"/>
										<C init_mean="0.2" init_std="0.02" min="-10" max="10" is_free="1"/>
									</Reflex>
									<Reflex type="VirtualMuscleReflex" target="subtalar_angle -1" delay="0.020">
										<L init_mean="2.0" init_std="0.2" min="0" max="10" is_free="1"/>
										<C init_mean="0.2" init_std="0.02" min="-10" max="10" is_free="1"/>
									</Reflex>
									
								</Reflexes>
							</Controller>
						</ConditionalController>
						
						<!-- Ankle push-off during late stance/liftoff (negative sign) -->
						<ConditionalController states="LateStance Liftoff">
							<Controller type="MetaReflexController">
								<Reflexes>
									<Reflex type="VirtualMuscleReflex" target="ankle_angle -1" delay="0.020">
										<L init_mean="0.5" init_std="0.01" min="0" max="10" is_free="1"/>
										<C init_mean="0.1" init_std="0.1" min="-10" max="10" is_free="1"/>
									</Reflex>
									<Reflex type="VirtualMuscleReflex" target="ankle_angle -1 knee_angle -1" delay="0.020">
										<L init_mean="3.0" init_std="0.01" min="0" max="10" is_free="1"/>
										<C init_mean="0.5" init_std="0.1" min="-10" max="10" is_free="1"/>
									</Reflex>
									<!-- Toe push-off -->
									<Reflex type="VirtualMuscleReflex" target="mtp_angle -1" delay="0.020">
										<L init_mean="0.2" init_std="0.1" min="0" max="10" is_free="1"/>
										<C init_mean="0.2" init_std="0.1" min="-10" max="10" is_free="1"/>
									</Reflex>
								</Reflexes>
							</Controller>
						</ConditionalController>
						
						<!-- Hip and knee liftoff/swing -->
						<ConditionalController states="Liftoff Swing">
							<Controller type="MetaReflexController">
								<Reflexes>
									<Reflex type="VirtualMuscleReflex" target="hip_flexion 1" delay="0.005">
										<L init_mean="2.0" init_std="0.1" min="0" max="10" is_free="1"/>
										<C init_mean="0.5" init_std="0.1" min="-1" max="1" is_free="1"/>
										<Balance body="torso">
											<C init_mean="-0.5" init_std="0.1" min="-1" max="1" is_free="1"/>
										</Balance>
									</Reflex>
									
									<Reflex type="VirtualMuscleReflex" target="hip_flexion 1 knee_angle 1" delay="0.005">
										<L init_mean="0.1" init_std="0.01" min="0" max="1" is_free="1"/>
										<C init_mean="0.05" init_std="0.01" min="-1" max="1" is_free="1"/>
									</Reflex>
								</Reflexes>
							</Controller>
						</ConditionalController>

						<!-- Ankle retraction during swing and landing -->
						<ConditionalController states="Swing, Landing">
							<Controller type="MetaReflexController">
								<Reflexes>
									<Reflex type="VirtualMuscleReflex" target="ankle_angle 1" delay="0.020">
										<L init_mean="2.0" init_std="0.2" min="0" max="10" is_free="1"/>
										<C init_mean="0.5" init_std="0.05" min="-10" max="10" is_free="1"/>
									</Reflex>
									<Reflex type="VirtualMuscleReflex" target="mtp_angle 1" delay="0.020">
										<L init_mean="1.0" init_std="0.1" min="0" max="10" is_free="1"/>
										<C init_mean="0.1" init_std="0.01" min="-10" max="10" is_free="1"/>
									</Reflex>
								</Reflexes>
							</Controller>
						</ConditionalController>

						<!-- Landing -->
						<ConditionalController states="Landing">
							<Controller type="MetaReflexController">
								<Reflexes>
									<!-- hamstring retraction reflex at end of swing -->
									<Reflex type="VirtualMuscleReflex" target="hip_flexion -1 knee_angle -1" delay="0.005">
										<L init_mean="0.2" init_std="0.02" min="0.0" max="10.0" is_free="1"/>
										<C init_mean="-0.1" init_std="0.01" min="-10" max="10" is_free="1"/>
									</Reflex>
									
									<!--hip adduction / abduction during landing-->
									<Reflex type="VirtualMuscleReflex" target="hip_adduction 1" delay="0.005">
										<L init_mean="0.1" init_std="0.01" min="0" max="10" is_free="1"/>
										<C init_mean="0.1" init_std="0.01" min="-1" max="1" is_free="1"/>
									</Reflex>
									<Reflex type="VirtualMuscleReflex" target="hip_adduction -1" delay="0.005">
										<L init_mean="0.1" init_std="0.01" min="0" max="10" is_free="1"/>
										<C init_mean="0.1" init_std="0.01" min="-1" max="1" is_free="1"/>
									</Reflex>
								</Reflexes>
							</Controller>
						</ConditionalController>
					</ConditionalControllers>
				</Controller>
				<INCLUDE file="measures/M_CG10_CoT.xml"/>
			</Controllers>
		</Model>
	</Objective>
</Optimizer>
