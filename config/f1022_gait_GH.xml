<?xml version="1.0" encoding="utf-8"?>
<Optimizer type="CmaOptimizer">
	<INCLUDE file="optimizations/O_CMA.xml" merge_children="1"/>
	<init_file></init_file>
	<use_init_file>0</use_init_file>
	<random_seed>123</random_seed>
	<Objective type="SimulationObjective">
		<signature_postfix>GH1</signature_postfix>
		<max_duration>5</max_duration>
		<Model type="Simbody">
			<model_file>f1022.osim</model_file>
			<state_init_file>f2354_init_walk_2_S12.sto</state_init_file>
			<state_init_optimization include_states="*" exclude_states="*_tx;*_ty;*_u" init_std="0.01" min="-0.5" max="0.5"/>
			<integration_method>SemiExplicitEuler2</integration_method>
			<integration_accuracy>0.001</integration_accuracy>
			<use_fixed_control_step_size>1</use_fixed_control_step_size>
			<fixed_control_step_size>0.001</fixed_control_step_size>
			<sensor_delay_scaling_factor>1.0</sensor_delay_scaling_factor>
			<Controllers>
				<Controller type="GaitStateController">
					<landing_threshold init_mean="0.1" init_std="0.01" min="-0.5" max="0.5" is_free="1"/>
					<stance_load_threshold init_mean="0.2" init_std="0.05" min="0.001" max="1.0" is_free="1"/>
					<!--swing_load_threshold init_mean="0.001" init_std="0.05" min="0.001" max="1.0" is_free="0"/-->
					<leg_load_sensor_delay>0.02</leg_load_sensor_delay>
					<ConditionalControllers>
					
						<!-- Feed forward components for three states -->
						<ConditionalController states="EarlyStance LateStance, Liftoff Swing, Landing">
							<Controller type="FeedForwardController">
								<use_symmetric_actuators>1</use_symmetric_actuators>
								<Function type="Polynomial">
									<degree>0</degree>
									<coefficient0 init_mean="0.05" init_std="0.01" min="0.01" max="1"/>
								</Function>
							</Controller>
						</ConditionalController>

						<!-- TA stretch reflexes, present during all states -->
						<ConditionalController states="EarlyStance LateStance Liftoff Swing Landing">
							<Controller type="ReflexController">
								<use_symmetric_actuators>1</use_symmetric_actuators>
								<Reflexes>
									<!-- TA =L+(TA) + F-(SOL) -->
									<Reflex type="MuscleReflex" target="tib_ant" delay="0.020">
										<KL init_mean="2.0" init_std="0.5" min="0.0" max="10.0" is_free="1"/>
										<L0 init_mean="0.9" init_std="0.1" min="0.0" max="2.0" is_free="1"/>
									</Reflex>
									<Reflex type="MuscleReflex" target="tib_ant" source="soleus" delay="0.020">
										<KF init_mean="-2.0" init_std="0.1" min="-10" max="10" is_free="1"/>
									</Reflex>
								</Reflexes>
							</Controller>
						</ConditionalController>

						<!-- Stance reflexes that also work during lift-off (i.e. F+ SOL / GAS)-->
						<ConditionalController states="LateStance Liftoff">
							<Controller type="ReflexController">
								<use_symmetric_actuators>1</use_symmetric_actuators>
								<Reflexes>
									<!-- F+ SOL -->
									<Reflex type="MuscleReflex" target="soleus" delay="0.020">
										<KF init_mean="0.4" init_std="0.1" min="0.0" max="10.0" is_free="1"/>
									</Reflex>
									<!-- F+ GAS -->
									<Reflex type="MuscleReflex" target="gastroc" delay="0.020">
										<KF init_mean="0.4" init_std="0.1" min="0.0" max="10.0" is_free="1"/>
									</Reflex>
								</Reflexes>
							</Controller>
						</ConditionalController>
						
						<!-- Stance reflexes, based on [Wang2012] -->
						<ConditionalController states="EarlyStance LateStance">
							<Controller type="ReflexController">
								<use_symmetric_actuators>1</use_symmetric_actuators>
								<Reflexes>
									<!-- F+ VAS -->
									<Reflex type="ConditionalMuscleReflex" target="vasti" delay="0.010">
										<KF init_mean="0.5" init_std="0.1" min="0.0" max="10.0" is_free="1"/>
										<Condition dof="knee_angle">
											<pos_range min="-180" max="-10"/>
										</Condition>
									</Reflex>
									
									<!-- Root stability -->
									<Reflex type="DofReflex" target="hamstrings" source="pelvis_tilt" delay="0.005">
										<KP init_mean="1.0" init_std="0.1" min="-10" max="10" is_free="1"/>
										<KV init_mean="0.2" init_std="0.02" min="-10" max="10" is_free="1"/>
									</Reflex>
									<Reflex type="DofReflex" target="glut_max" source="pelvis_tilt" delay="0.005">
										<KP init_mean="1.0" init_std="0.1" min="-10" max="10" is_free="1"/>
										<KV init_mean="0.2" init_std="0.02" min="-10" max="10" is_free="1"/>
									</Reflex>
									<Reflex type="DofReflex" target="iliopsoas" source="pelvis_tilt" delay="0.005">
										<KP init_mean="-1.0" init_std="0.1" min="-10" max="10" is_free="1"/>
										<KV init_mean="-0.2" init_std="0.02" min="-10" max="10" is_free="1"/>
									</Reflex>
									
									<!-- Upper body stability -->
									<Reflex type="DofReflex" target="ercspn" source="lumbar_extension" delay="0.005">
										<KP init_mean="1.0" init_std="0.1" min="-10" max="10" is_free="1"/>
										<KV init_mean="0.2" init_std="0.02" min="-10" max="10" is_free="1"/>
									</Reflex>
									<Reflex type="DofReflex" target="intobl" source="lumbar_extension" delay="0.005">
										<KP init_mean="-1.0" init_std="0.1" min="-10" max="10" is_free="1"/>
										<KV init_mean="-0.2" init_std="0.02" min="-10" max="10" is_free="1"/>
									</Reflex>
								</Reflexes>
							</Controller>						
						</ConditionalController>
						<ConditionalController states="Liftoff Swing">
							<!-- Swing reflexes, based on [Wang2012] -->
							<Controller type="ReflexController">
								<use_symmetric_actuators>1</use_symmetric_actuators>
								<Reflexes>
									<!-- L+ reflex for hip flexion (not in [Wang2012]) -->
									<Reflex type="MuscleReflex" target="iliopsoas" delay="0.005">
										<KL	init_mean="3.0" init_std="0.1" min="0.0" max="10.0" is_free="1"/>
										<L0	init_mean="0.5" init_std="0.1" min="0.0" max="2.0" is_free="1"/>
									</Reflex>
									<!-- L+ reflex for hip flexion (not in [Wang2012]) -->
									<Reflex type="MuscleReflex" target="rect_fem" delay="0.005">
										<KL	init_mean="0.5" init_std="0.1" min="0.0" max="10.0" is_free="1"/>
										<L0	init_mean="0.9" init_std="0.1" min="0.0" max="2.0" is_free="1"/>
									</Reflex>
									<!-- Balance hip correction -->
									<Reflex type="DofReflex" target="iliopsoas" source="lumbar_extension" delay="0.005">
										<KP init_mean="-1.0" init_std="0.1" min="-10" max="10" is_free="1"/>
										<KV init_mean="-0.2" init_std="0.02" min="-10" max="10" is_free="1"/>
									</Reflex>
								</Reflexes>
							</Controller>						
						</ConditionalController>
						
						<!-- Landing reflexes, based on [Wang2012] -->
						<ConditionalController states="Landing">
							<Controller type="ReflexController">
								<use_symmetric_actuators>1</use_symmetric_actuators>
								<Reflexes>
									<!-- F+ retraction reflex for end of swing -->
									<Reflex type="MuscleReflex" target="hamstrings" delay="0.005">
										<KF init_mean="0.5" init_std="0.05" min="0.0" max="10.0" is_free="1"/>
									</Reflex>
									<Reflex type="MuscleReflex" target="glut_max" delay="0.005">
										<KF init_mean="0.1" init_std="0.05" min="0.0" max="10.0" is_free="1"/>
									</Reflex>
								</Reflexes>
							</Controller>						
						</ConditionalController>
					</ConditionalControllers>
				</Controller>
				<INCLUDE file="measures/M_CG10_CoT.xml"/>
			</Controllers>
		</Model>
	</Objective>
</Optimizer>
